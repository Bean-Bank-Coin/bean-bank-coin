name: Flyway4

on:
  
  pull_request:
    # types:
    #   - closed
    branches:
      - main

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      
      - name: Install Flyway
        run: |
          wget -qO- https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/8.5.1/flyway-commandline-8.5.1-linux-x64.tar.gz | tar xvz
          sudo ln -s $(pwd)/flyway-8.5.1/flyway /usr/local/bin/flyway

      - name: Generate Flyway Configuration
        run: |
          echo "flyway.url=jdbc:mysql://bean-bank-coin-db-mysql.cbsozziiwdya.eu-west-1.rds.amazonaws.com:3306/bean_bank_coin_db" > flyway.conf
          echo "flyway.schemas=bean_bank_coin_db" >> flyway.conf
          echo "flyway.user=admin" >> flyway.conf
          echo "flyway.password=${{secrets.DB_BUILD_PASSWORD}}" >> flyway.conf
          echo "flyway.validateMigrationNaming=true" >> flyway.coSxj~eL$_1m#YXno%nL_}W.X2_YLenf
          echo "flyway.locations=filesystem:sql" >> flyway.conf

      - name: Run Flyway Migration
        run: flyway -configFiles=" flyway.conf" migrate
